name: Notify Slack on Update

on:
  push:
    branches: [main]
    paths:
      - '**/*.html'
      - '**/*.css'
      - '**/*.js'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Send Slack notification
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          MESSAGE=$(python3 << 'PYEOF'
          import json
          import os

          url = "https://ucarpac.github.io/biz-prototypes/ucarpac-app/"

          blocks = [
              {
                  "type": "header",
                  "text": {"type": "plain_text", "text": ":art: プロトタイプが更新されました", "emoji": True}
              },
              {
                  "type": "section",
                  "text": {"type": "mrkdwn", "text": ":key: *Password:* `ucarpac2026`"}
              },
              {
                  "type": "actions",
                  "elements": [
                      {"type": "button", "text": {"type": "plain_text", "text": "プロトタイプを見る"}, "url": url, "style": "primary"}
                  ]
              }
          ]

          payload = {"channel": os.environ["SLACK_CHANNEL_ID"], "blocks": blocks}
          print(json.dumps(payload))
          PYEOF
          )

          curl -s -X POST "https://slack.com/api/chat.postMessage" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d "$MESSAGE"
