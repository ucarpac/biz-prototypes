name: Notify Slack on Update

on:
  push:
    branches: [main]
    paths:
      - '**/*.html'
      - '**/*.css'
      - '**/*.js'
      - 'ops/auto-kpi/**/*.json'
      - 'ops/auto-kpi/**/*.md'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Collect commit metadata
        id: meta
        run: |
          echo "message=$(git log -1 --pretty=%s)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          CHANGED=$(git diff --name-only HEAD~1 HEAD | head -8 | tr '\n' ', ' | sed 's/, $//')
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          COMMIT_MESSAGE: ${{ steps.meta.outputs.message }}
          COMMIT_AUTHOR: ${{ steps.meta.outputs.author }}
          CHANGED_FILES: ${{ steps.meta.outputs.changed }}
        run: |
          MESSAGE=$(python3 << 'PYEOF'
          import json
          import os
          prototype_url = "https://ucarpac.github.io/biz-prototypes/ucarpac-app/"
          report_url = "https://ucarpac.github.io/biz-prototypes/ops/auto-kpi/"
          text = (
              ":rocket: 更新されました\n"
              f"・概要: {os.environ.get('COMMIT_MESSAGE','-')}\n"
              f"・URL(Prototype): {prototype_url}\n"
              f"・URL(Report): {report_url}\n"
              "・Password: ucarpac2026"
          )
          payload = {"channel": os.environ["SLACK_CHANNEL_ID"], "text": text}
          print(json.dumps(payload))
          PYEOF
          )

          curl -s -X POST "https://slack.com/api/chat.postMessage" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d "$MESSAGE"
