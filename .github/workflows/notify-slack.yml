name: Notify Slack on Update

on:
  push:
    branches: [main]
    paths:
      - '**/*.html'
      - '**/*.css'
      - '**/*.js'
      - 'ops/auto-kpi/**/*.json'
      - 'ops/auto-kpi/**/*.md'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Collect commit metadata
        id: meta
        run: |
          echo "message=$(git log -1 --pretty=%s)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          CHANGED=$(git diff --name-only HEAD~1 HEAD | head -8 | tr '\n' ', ' | sed 's/, $//')
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          COMMIT_MESSAGE: ${{ steps.meta.outputs.message }}
          COMMIT_AUTHOR: ${{ steps.meta.outputs.author }}
          CHANGED_FILES: ${{ steps.meta.outputs.changed }}
        run: |
          MESSAGE=$(python3 << 'PYEOF'
          import json
          import os
          from pathlib import Path

          prototype_url = "https://ucarpac.github.io/biz-prototypes/ucarpac-app/"
          report_summary_path = Path("ops/auto-kpi/notification-summary.json")
          report_url = "https://ucarpac.github.io/biz-prototypes/ops/auto-kpi/"
          summary = {}
          if report_summary_path.exists():
              try:
                  summary = json.loads(report_summary_path.read_text(encoding="utf-8"))
              except json.JSONDecodeError:
                  summary = {}

          selected = summary.get("selected", {}) if isinstance(summary, dict) else {}
          deep = summary.get("deep_dive", {}) if isinstance(summary, dict) else {}
          sc = summary.get("search_console", {}) if isinstance(summary, dict) else {}
          ga4 = summary.get("ga4", {}) if isinstance(summary, dict) else {}
          mode = summary.get("mode", "-")
          date = summary.get("date", "-")
          skipped = summary.get("skipped", False)
          reason = summary.get("reason", "")
          alerts = summary.get("alerts", []) if isinstance(summary.get("alerts", []), list) else []
          alert_count = summary.get("alert_count", 0)
          report_url = summary.get("report_url", report_url)

          title = selected.get("title", "未選定")
          kpi = selected.get("kpi", "-")
          assess_cv = deep.get("assess_cv", "-")
          cpa_jpy = deep.get("cpa_jpy", "-")
          final_yield = deep.get("final_yield_pct", "-")
          cv_to_contract = deep.get("cv_to_contract_yield_pct", "-")
          conversion_action = deep.get("conversion_action", "査定依頼")
          insight = deep.get("insight", "")
          sc_insight = sc.get("insight", "")
          ga4_insight = ga4.get("insight", "")

          sc_clicks = sc.get("clicks", "-")
          sc_ctr = sc.get("ctr_pct", "-")
          sc_position = sc.get("avg_position", "-")
          sc_organic_cv = sc.get("organic_assess_complete_cv", "-")

          ga4_cv_event = ga4.get("cv_event", "査定依頼完了")
          ga4_complete_cv = ga4.get("assess_complete_cv", "-")
          ga4_session_to_complete = ga4.get("session_to_complete_pct", "-")
          ga4_complete_to_contract = ga4.get("complete_to_contract_pct", "-")
          def pct(value):
              if value in (None, "", "-"):
                  return "-"
              return f"{value}%"

          status_text = "通常実行"
          if skipped:
              status_text = f"スキップ ({reason})"
          elif alert_count:
              status_text = f"アラート {alert_count}件"

          blocks = [
              {
                  "type": "header",
                  "text": {"type": "plain_text", "text": ":rocket: Auto KPI / Prototype 更新", "emoji": True}
              },
              {
                  "type": "section",
                  "fields": [
                      {"type": "mrkdwn", "text": f"*Commit:*\n{os.environ.get('COMMIT_MESSAGE','-')}"},
                      {"type": "mrkdwn", "text": f"*Author:*\n{os.environ.get('COMMIT_AUTHOR','-')}"},
                      {"type": "mrkdwn", "text": f"*Mode / Date:*\n{mode} / {date}"},
                      {"type": "mrkdwn", "text": f"*Run Status:*\n{status_text}"},
                  ]
              },
              {
                  "type": "section",
                  "text": {
                      "type": "mrkdwn",
                      "text": (
                          f"*Theme:* {title}\n"
                          f"*KPI:* {kpi}\n"
                          f"*CV Definition:* {conversion_action}"
                      )
                  }
              },
              {
                  "type": "section",
                  "fields": [
                      {"type": "mrkdwn", "text": f"*査定依頼CV:*\n{assess_cv}"},
                      {"type": "mrkdwn", "text": f"*CPA:*\n{cpa_jpy}"},
                      {"type": "mrkdwn", "text": f"*最終歩留まり:*\n{final_yield}%"},
                      {"type": "mrkdwn", "text": f"*CV→成約歩留まり:*\n{cv_to_contract}%"},
                  ]
              },
              {
                  "type": "section",
                  "fields": [
                      {"type": "mrkdwn", "text": f"*SC クリック:*\n{sc_clicks}"},
                      {"type": "mrkdwn", "text": f"*SC CTR:*\n{pct(sc_ctr)}"},
                      {"type": "mrkdwn", "text": f"*SC 平均掲載順位:*\n{sc_position}"},
                      {"type": "mrkdwn", "text": f"*Organic 完了CV:*\n{sc_organic_cv}"},
                  ]
              },
              {
                  "type": "section",
                  "fields": [
                      {"type": "mrkdwn", "text": f"*GA4 CV Event:*\n{ga4_cv_event}"},
                      {"type": "mrkdwn", "text": f"*GA4 完了CV:*\n{ga4_complete_cv}"},
                      {"type": "mrkdwn", "text": f"*Session→完了率:*\n{pct(ga4_session_to_complete)}"},
                      {"type": "mrkdwn", "text": f"*完了→成約率:*\n{pct(ga4_complete_to_contract)}"},
                  ]
              },
              {
                  "type": "section",
                  "text": {"type": "mrkdwn", "text": f"*Changed Files:*\n{os.environ.get('CHANGED_FILES','-')}"}
              },
              {
                  "type": "actions",
                  "elements": [
                      {
                          "type": "button",
                          "text": {"type": "plain_text", "text": "プロトタイプを見る"},
                          "url": prototype_url,
                          "style": "primary"
                      },
                      {
                          "type": "button",
                          "text": {"type": "plain_text", "text": "Auto KPIレポート"},
                          "url": report_url
                      }
                  ]
              }
          ]
          if insight:
              blocks.insert(
                  4,
                  {
                      "type": "section",
                      "text": {"type": "mrkdwn", "text": f"*Insight:*\n{insight}"},
                  },
              )
          if sc_insight:
              blocks.insert(
                  5,
                  {
                      "type": "section",
                      "text": {"type": "mrkdwn", "text": f"*Search Console Insight:*\n{sc_insight}"},
                  },
              )
          if ga4_insight:
              blocks.insert(
                  6,
                  {
                      "type": "section",
                      "text": {"type": "mrkdwn", "text": f"*GA4 Insight:*\n{ga4_insight}"},
                  },
              )
          if alerts:
              alert_text = "\n".join([f"・{a}" for a in alerts[:4]])
              blocks.insert(
                  7,
                  {
                      "type": "section",
                      "text": {"type": "mrkdwn", "text": f":warning: *Alerts:*\n{alert_text}"},
                  },
              )
          blocks.insert(
              1,
              {"type": "section", "text": {"type": "mrkdwn", "text": ":key: *Password:* `ucarpac2026`"}},
          )

          payload = {"channel": os.environ["SLACK_CHANNEL_ID"], "blocks": blocks}
          print(json.dumps(payload))
          PYEOF
          )

          curl -s -X POST "https://slack.com/api/chat.postMessage" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d "$MESSAGE"
